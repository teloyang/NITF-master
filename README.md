# Nemo's Interface Test Framework 接口自动化测试框架

## 说明

> 本框架是针对JSON REST API设计的测试框架，框架构成为`Python + Unittest(Pytest) + Excel`。可执行单个接口的测试和流程用例的测试。
本框架示例采用 [小白接口](http://api.okayapi.com/docs.php) 提供的免费API。同时因其中涉及到`签名（sign）`均是采用该接口为示例。可根据情况修改（代码中已使用TODO标注）。


## 框架思路
参考了目前网上很多案例，发现很多搭建API平台，这种平台搭建起来虽然很炫。但是一是技能要求较高，二是降低了灵活性。

**为何用Excel：**
我们测试人员在写测试用例的时候，虽然有很多的工具，但是依旧没有Excel写起来更有效率。这是因为Excel可以灵活的复制粘贴，还有各种规则。而观之各种工具，很多只能一条条的写用例，效率大大降低；或者写Excel导进去，这也就等于承认了Excel写起来更有效率。
而接口测试，对于单一接口，因为要测试各种参数、各种响应等测试，用例量非常大，而每个用例之间其实差别很小。那么利用Excel的复制粘贴就有先天优势。

**为何用Unittest：**
现在由于各种测试框架的流行，unit系的测试框架被部分人摒弃，但是个人觉得用unit系写出来的用例规范性、可读性、易理解性都更好。
同时使用unittest写出的testcase，可以通过pytest等框架执行，扩展性依然不错。

**设计思路：**
使用`Python`语言搭建框架，主要处理从Excel中读取出设计好的测试用例。通过处理，可以针对每个Excel中的sheet页，生成一个unittest用例类的脚本，其中使用ddt参数化用例数据。再使用unittest的discover或者pytest去执行这些用例脚本。
- 对于单个用例，一个sheet页针对一个接口；
- 对于流程用例，一个sheet页针对一条流程。

其中花了较大篇幅处理数据的依赖，主要针对三种数据依赖进行了处理：
1. 响应依赖，部分接口的参数值依赖于其他用例的响应结果。比如`获取用户资料`的接口，需要传递token，而token要从`登录接口`之后的响应中获取；
2. 随机数依赖，有些接口某些参数有唯一性检查，为保证用例能重复运行，需要在参数中添加随机数。比如注册接口中的登录账号参数，该参数有唯一性检查；
3. 数据库依赖，有些时候某些接口在测试过程中参数可能需要从数据库中获取，或者是需要从数据库中获取数据作为断言。

## 实现

**对数据依赖的处理：**
设定参数规则为：
1. 响应依赖`$p{}`, 
2. 随机数依赖`$r{}`, 
3. 数据库依赖`$s{}`。

**响应依赖：**
响应依赖，采用$p{}形式：
如`$p{id:data.uuid}`, 表示需要获取依赖数据
- id：表示依赖的用例id， 
- data.uuid表示依赖用例的Response中的字段所在层级

例如: `$p{use_login1:data.uuid}`， 表示需要从用例ui为use_login1响应中的json数据中data对象中的uuid的值
    use_login1的响应 {"res":200, "data":{"uuid":"xxx", token="yyy"}}。则可以获取到xxx。
    
data.uuid为`jsonpath`的查找规则，更多查找规则请查阅：https://pypi.org/project/jsonpath-rw/

**随机数依赖：**
随机数依赖采用`$r{}`形式，如：$r{x},处理过程为默认添加4位随机的ascII字符（大小写字母和数字），为保证随机数能被复用x 为全局的变量，如果在第一个用例（任意地方）设置了$r{x}，那么任意地方使用$r{x}都会和第一个用例中的随机数一样
当需要使用不同的随机数时，需要修改x参数的值，如$r{xyz}

**数据库依赖：**
数据库依赖采用`$s{}`形式，表示此处需要查询数据库，参数内容为SQL语句
目前仅支持一条SQL查询一个字段内容，如 uuid=$s{select uuid from user where username='nemo'}

**参数传值方式：**
通过正则表达式查找用例字段中是否存在参数，如果有参数则使用运算出的实际的值替换掉参数。使用正则表达式提取出当前字段中的所有参数。逐一进行处理，比如需要响应数据的、随机数、SQL查询结果的，在获取到这些数据后，采用正则表达式中的sub方法替换掉其中的第一个参数，一次只处理一个参数，通过for循环将所有参数替换为实际的值。

## 使用

例如对于流程`注册>登录>获取用户资料`这样一个流程，简单的正向用例如下：

 
用例id | 接口名称 | 接口方法 | 接口地址 | 接口参数 | 断言
---|---|---|---|---|---
user_register | 注册录接口 | post | /register | username=nemo$r{name};password=123456 | code=200
user_login | 登录接口 | post | /login | username=nemo$r{name};password=123456 | code=200
user_profile | 获取用户资料 | post | /user/profile | uuid=$p{user_login:data.uuid};token=$p{user_login:data.token} | code=200;realname=$s{select realname from user where id=50}
